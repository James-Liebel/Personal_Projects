<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>US Education Choropleth | James Liebel</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #0f172a;
      --secondary: #64748b;
      --accent: #10b981;
      --card-bg: #ffffff;
    }

    body {
      font-family: 'Outfit', sans-serif;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: #f1f5f9;
      color: var(--primary);
    }

    .container {
      background: var(--card-bg);
      padding: 40px;
      border-radius: 32px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
      position: relative;
      max-width: 1000px;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
    }

    #title {
      font-size: 32px;
      font-weight: 600;
      color: var(--primary);
      margin: 0;
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    #description {
      font-size: 16px;
      color: var(--secondary);
      margin: 10px 0 0 0;
    }

    #chart-canvas {
      position: relative;
      background: #fff;
      border-radius: 16px;
      overflow: hidden;
    }

    .county {
      stroke: #fff;
      stroke-width: 0.15;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: crosshair;
    }

    .county:hover {
      stroke: #0f172a;
      stroke-width: 1.5;
      opacity: 0.9;
      filter: saturate(1.5);
    }

    #tooltip {
      position: absolute;
      padding: 14px 18px;
      background: rgba(15, 23, 42, 0.95);
      color: #fff;
      border-radius: 14px;
      pointer-events: none;
      opacity: 0;
      font-size: 13px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(8px);
      z-index: 1000;
      line-height: 1.5;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .state-borders {
      fill: none;
      stroke: #fff;
      stroke-linejoin: round;
      pointer-events: none;
      stroke-width: 0.8px;
      opacity: 0.8;
    }

    #legend text {
      font-size: 11px;
      font-weight: 500;
      fill: var(--secondary);
    }

    .legend-title {
      font-size: 12px;
      font-weight: 600;
      fill: var(--primary) !important;
    }

    .loading-overlay {
      position: absolute;
      inset: 0;
      background: white;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      font-weight: 600;
      color: var(--secondary);
      border-radius: 32px;
      transition: opacity 0.5s;
    }
  </style>
</head>

<body>
  <div class="container" id="main-container">
    <div class="loading-overlay" id="loader">Processing Geographic Data...</div>
    <header>
      <h1 id="title">US Higher Education Density</h1>
      <p id="description">Socioeconomic analysis of degree attainment by US County (2010-2014)</p>
    </header>

    <div id="tooltip"></div>
    <div id="chart-canvas"></div>
  </div>

  <script>
    const width = 960;
    const height = 640;

    const svg = d3.select("#chart-canvas")
      .append("svg")
      .attr("viewBox", `0 0 ${width} ${height}`)
      .attr("width", "100%")
      .attr("height", "auto");

    const tooltip = d3.select("#tooltip");

    const files = [
      "https://raw.githubusercontent.com/freeCodeCamp/ProjectReferenceData/master/counties.json",
      "https://raw.githubusercontent.com/freeCodeCamp/ProjectReferenceData/master/for_user_education.json"
    ];

    Promise.all(files.map(url => d3.json(url))).then(([countyData, educationData]) => {
      // Create an optimized lookup Map for O(1) retrieval
      const eduLookup = new Map(educationData.map(d => [d.fips, d]));

      // Color Scale - Using a more "Dense" multi-hue scale for better contrast
      const colorScale = d3.scaleThreshold()
        .domain([3, 12, 21, 30, 39, 48, 57, 66])
        .range(d3.schemeYlGnBu[9]);

      const path = d3.geoPath();

      // Draw Counties
      svg.append("g")
        .selectAll("path")
        .data(topojson.feature(countyData, countyData.objects.counties).features)
        .enter()
        .append("path")
        .attr("class", "county")
        .attr("fill", d => {
          const edu = eduLookup.get(d.id);
          return edu ? colorScale(edu.bachelorsOrHigher) : "#ccc";
        })
        .attr("d", path)
        .on("mouseover", (event, d) => {
          const edu = eduLookup.get(d.id);
          if (!edu) return;

          tooltip.transition().duration(50).style("opacity", 1);
          tooltip.html(`
            <div style="margin-bottom: 4px; font-weight: 600; font-size: 14px; color: #10b981;">${edu.area_name}, ${edu.state}</div>
            <div style="font-size: 20px; font-weight: 600;">${edu.bachelorsOrHigher}%</div>
            <div style="color: #94a3b8; font-size: 11px; margin-top: 4px;">Bachelor's Degree or Higher</div>
          `)
            .style("left", (event.pageX + 20) + "px")
            .style("top", (event.pageY - 60) + "px");
        })
        .on("mousemove", (event) => {
          tooltip.style("left", (event.pageX + 20) + "px")
            .style("top", (event.pageY - 60) + "px");
        })
        .on("mouseout", () => {
          tooltip.transition().duration(300).style("opacity", 0);
        });

      // Draw State Borders
      svg.append("path")
        .datum(topojson.mesh(countyData, countyData.objects.states, (a, b) => a !== b))
        .attr("class", "state-borders")
        .attr("d", path);

      // Enhanced Legend
      const xLegend = d3.scaleLinear().domain([3, 66]).rangeRound([600, 860]);
      const legend = svg.append("g")
        .attr("id", "legend")
        .attr("transform", "translate(0, 40)");

      const legendData = colorScale.range().map(d => {
        d = colorScale.invertExtent(d);
        if (d[0] == null) d[0] = xLegend.domain()[0];
        if (d[1] == null) d[1] = xLegend.domain()[1];
        return d;
      });

      legend.selectAll("rect")
        .data(legendData)
        .enter().append("rect")
        .attr("height", 10)
        .attr("x", d => xLegend(d[0]))
        .attr("width", d => xLegend(d[1]) - xLegend(d[0]))
        .attr("fill", d => colorScale(d[0]))
        .attr("rx", 2);

      legend.append("text")
        .attr("class", "legend-title")
        .attr("x", xLegend.range()[0])
        .attr("y", -10)
        .text("Higher Education attainment (%)");

      legend.call(d3.axisBottom(xLegend)
        .tickSize(15)
        .tickFormat(x => Math.round(x) + "%")
        .tickValues(colorScale.domain()))
        .select(".domain")
        .remove();

      // Hide Loader
      d3.select("#loader").transition().duration(500).style("opacity", 0).remove();
    }).catch(err => {
      console.error(err);
      d3.select("#loader").text("Critical Error Loading Map Data");
    });
  </script>
</body>

</html>