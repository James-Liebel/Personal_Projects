<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cincinnati Food Access | Choropleth Map</title>
  <meta name="description" content="Visualizing food access and deserts in Cincinnati neighborhoods using D3.js.">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #0c0e14;
      --panel-bg: rgba(255, 255, 255, 0.03);
      --accent-color: #f59e0b;
      --text-primary: #f8fafc;
      --text-secondary: #94a3b8;
      --desert-color: #ef4444;
      --high-access-color: #10b981;
      --border-glow: rgba(245, 158, 11, 0.2);
    }

    body {
      margin: 0;
      padding: 0;
      background-color: var(--bg-color);
      color: var(--text-primary);
      font-family: 'Outfit', sans-serif;
      overflow: hidden;
      display: flex;
    }

    #map-container {
      flex-grow: 1;
      height: 100vh;
      position: relative;
    }

    #sidebar {
      width: 380px;
      height: 100vh;
      background: var(--panel-bg);
      backdrop-filter: blur(20px);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      padding: 2rem;
      display: flex;
      flex-direction: column;
      z-index: 10;
      overflow-y: auto;
    }

    h1 {
      font-size: 1.8rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, #fff 0%, #94a3b8 100%);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .subtitle {
      color: var(--text-secondary);
      font-size: 0.9rem;
      line-height: 1.5;
      margin-bottom: 1.5rem;
    }

    .legend {
      background: rgba(0, 0, 0, 0.2);
      padding: 1.5rem;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      margin-bottom: 1rem;
    }

    .legend-title {
      font-weight: 600;
      margin-bottom: 0.75rem;
      font-size: 0.9rem;
      color: var(--accent-color);
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
      font-size: 0.8rem;
    }

    .color-box {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      margin-right: 10px;
      flex-shrink: 0;
    }

    .marker-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 10px;
      flex-shrink: 0;
    }

    #tooltip {
      position: absolute;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(8px);
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      pointer-events: none;
      opacity: 0;
      font-size: 0.85rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
      transition: opacity 0.1s;
      max-width: 280px;
      top: 20px;
      left: 20px;
    }

    .neighborhood {
      stroke: rgba(255, 255, 255, 0.2);
      stroke-width: 0.5px;
      transition: all 0.3s;
    }

    .neighborhood:hover {
      stroke: var(--accent-color);
      stroke-width: 2px;
      filter: brightness(1.2);
    }

    .store-marker {
      stroke: rgba(0, 0, 0, 0.5);
      stroke-width: 1px;
      cursor: pointer;
      transition: r 0.2s, opacity 0.2s;
    }

    .store-marker:hover {
      r: 10 !important;
      opacity: 1 !important;
    }

    .stats-box {
      background: rgba(0, 0, 0, 0.3);
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-size: 0.8rem;
    }

    .stat-value {
      color: var(--accent-color);
      font-weight: 600;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animated {
      animation: fadeIn 0.8s ease-out forwards;
    }

    .filter-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: var(--text-primary);
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      font-size: 0.75rem;
      cursor: pointer;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
      transition: all 0.2s;
    }

    .filter-btn:hover,
    .filter-btn.active {
      background: var(--accent-color);
      border-color: var(--accent-color);
    }

    #filters {
      display: flex;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }

    .nav-btn {
      display: block;
      margin-bottom: 1.5rem;
      padding: 10px 16px;
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: #4ade80;
      text-decoration: none;
      border-radius: 8px;
      text-align: center;
      font-size: 0.85rem;
      font-weight: 500;
      transition: background 0.2s;
    }

    .nav-btn:hover {
      background: rgba(34, 197, 94, 0.2);
    }

    .source-note {
      margin-top: auto;
      padding-top: 1rem;
      font-size: 0.75rem;
      color: var(--text-secondary);
      line-height: 1.5;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
  </style>
</head>

<body>
  <div id="sidebar">
    <h1 class="animated">Cincinnati Food Landscapes</h1>
    <p class="subtitle animated" style="animation-delay: 0.1s;">
      Interactive map of food access using <strong>USDA Food Desert</strong> definitions. Exploring Low-Income and
      Low-Access (LILA) areas.
    </p>

    <a href="food_deserts.html" class="nav-btn animated" style="animation-delay: 0.12s;">
      → Switch to Risk & Swamp Analysis
    </a>

    <div id="filters" class="animated" style="animation-delay: 0.15s;">
      <button class="filter-btn active" data-type="all">All (1470+)</button>
      <button class="filter-btn" data-type="Restaurant">Restaurants</button>
      <button class="filter-btn" data-type="Fast Food">Fast Food</button>
      <button class="filter-btn" data-type="Grocery Store">Grocery</button>
      <button class="filter-btn" data-type="Convenience/Market">Markets</button>
      <button class="filter-btn" data-type="Gas Station">Gas Stations</button>
      <button class="filter-btn" data-type="Coffee Shop">Coffee</button>
      <button class="filter-btn" data-type="Specialty Food">Specialty</button>
      <button class="filter-btn" data-type="Dollar Store">Dollar</button>
      <button class="filter-btn" data-type="Pharmacy">Pharmacy</button>
    </div>

    <div class="legend animated" style="animation-delay: 0.2s;">
      <div class="legend-title">Food Access Heat Map</div>
      <div style="display: flex; align-items: center; margin-bottom: 0.75rem;">
        <span style="font-size: 0.7rem; color: #22c55e; margin-right: 0.3rem;">Close</span>
        <div
          style="flex: 1; height: 14px; border-radius: 7px; background: linear-gradient(to right, #22c55e, #84cc16, #eab308, #dc2626, #7f1d1d);">
        </div>
        <span style="font-size: 0.7rem; color: #dc2626; margin-left: 0.3rem;">Far</span>
      </div>
      <div class="legend-item">
        <div
          style="width: 20px; height: 20px; background: transparent; border: 2.5px dashed #fbbf24; margin-right: 10px;">
        </div>
        <span>USDA Food Desert (Low Income + >1mi)</span>
      </div>
      <div class="legend-item">
        <div
          style="width: 20px; height: 20px; background: transparent; border: 1.5px solid rgba(255,255,255,0.9); margin-right: 10px;">
        </div>
        <span>White outline = Sufficient Access</span>
      </div>
      <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.5rem; line-height: 1.4;">
        <strong>USDA Definition:</strong><br>
        1. <strong>Low Income:</strong> Poverty rate ≥ 20%<br>
        2. <strong>Low Access:</strong> Neighborhood center > 1 mile from nearest supermarket.
      </div>
    </div>

    <div class="legend animated" style="animation-delay: 0.25s;">
      <div class="legend-title">Food Establishment Types</div>
      <div class="legend-item">
        <div class="marker-dot" style="background: #ef4444;"></div>
        <span>Restaurant (458)</span>
      </div>
      <div class="legend-item">
        <div class="marker-dot" style="background: #f97316;"></div>
        <span>Fast Food (190)</span>
      </div>
      <div class="legend-item">
        <div class="marker-dot" style="background: #22c55e;"></div>
        <span>Grocery Store (68)</span>
      </div>
      <div class="legend-item">
        <div class="marker-dot" style="background: #3b82f6;"></div>
        <span>Convenience/Market (290)</span>
      </div>
      <div class="legend-item">
        <div class="marker-dot" style="background: #eab308;"></div>
        <span>Gas Station (133)</span>
      </div>
      <div class="legend-item">
        <div class="marker-dot" style="background: #8b5cf6;"></div>
        <span>Coffee Shop (126)</span>
      </div>
      <div class="legend-item">
        <div class="marker-dot" style="background: #ec4899;"></div>
        <span>Specialty Food (108)</span>
      </div>
      <div class="legend-item">
        <div class="marker-dot" style="background: #a855f7;"></div>
        <span>Dollar Store (43)</span>
      </div>
      <div class="legend-item">
        <div class="marker-dot" style="background: #14b8a6;"></div>
        <span>Pharmacy (13)</span>
      </div>
    </div>

    <div class="stats-box animated" style="animation-delay: 0.3s;">
      <div class="legend-title">Data Summary</div>
      <div class="stat-row">
        <span>Total Locations</span>
        <span class="stat-value" id="total-count">--</span>
      </div>
      <div class="stat-row">
        <span>USDA Food Deserts</span>
        <span class="stat-value" id="desert-count">--</span>
      </div>
      <div class="stat-row">
        <span>Total Neighborhoods</span>
        <span class="stat-value">52</span>
      </div>
    </div>

    <div class="source-note animated" style="animation-delay: 0.35s;">
      <strong>Data Sources:</strong><br>
      Locations: Cincinnati Food Safety Program (2024-2025). <br>
      Poverty Rates based on 2016-2020 ACS estimates and known high-poverty zones.
    </div>
  </div>

  <div id="map-container">
    <div id="tooltip"></div>
  </div>

  <script>
    const width = window.innerWidth - 380;
    const height = window.innerHeight;

    const svg = d3.select("#map-container")
      .append("svg")
      .attr("width", "100%")
      .attr("height", "100%")
      .attr("height", "100%")
      .attr("viewBox", `0 0 ${width} ${height}`);

    const g = svg.append("g");
    const tooltip = d3.select("#tooltip");

    const typeColors = {
      "Restaurant": "#ef4444",
      "Fast Food": "#f97316",
      "Grocery Store": "#22c55e",
      "Convenience/Market": "#3b82f6",
      "Gas Station": "#eab308",
      "Coffee Shop": "#8b5cf6",
      "Specialty Food": "#ec4899",
      "Dollar Store": "#a855f7",
      "Pharmacy": "#14b8a6",
      "Dessert": "#f472b6",
      "Farmers Market/Health": "#84cc16"
    };

    let allMarkers = [];
    let projection;
    let geoDataGlobal;
    let neighborhoodStats = {};

    // USDA Rules
    const EARTH_RADIUS_MILES = 3959;
    const POVERTY_THRESHOLD = 0.20; // 20%
    const ACCESS_DISTANCE_MILES = 1.0; // 1 Mile for Urban

    // Known Poverty Estimates (Approx from 2020-2022 Reports)
    const povertyEstimates = {
      "Lower Price Hill": 0.77,
      "Villages at Roll Hill": 0.67,
      "Winton Hills": 0.65,
      "Over-the-Rhine": 0.56,
      "South Cumminsville": 0.51,
      "Millvale": 0.51,
      "North Fairmount": 0.51,
      "English Woods": 0.51,
      "West End": 0.49,
      "Avondale": 0.33,
      "Walnut Hills": 0.33,
      "East Price Hill": 0.30,
      "West Price Hill": 0.25,
      "Westwood": 0.20,
      "Mount Auburn": 0.25,
      "Hyde Park": 0.05,
      "Mt. Lookout": 0.04,
      "Oakley": 0.08,
      "Columbia Tusculum": 0.06,
      "Mount Adams": 0.05,
      "Evanston": 0.28,
      "Bond Hill": 0.25,
      "Roselawn": 0.25
    };

    async function init() {
      try {
        const [geoData, foodData] = await Promise.all([
          d3.json("cincinnati_neighborhoods.geojson"),
          d3.json("food_data.json")
        ]);

        if (!geoData || !geoData.features) {
          throw new Error("Invalid GeoJSON");
        }

        geoDataGlobal = geoData;
        projection = d3.geoMercator().fitSize([width, height], geoData);
        const path = d3.geoPath().projection(projection);

        // Filter markers to only those within neighborhood boundaries
        const validMarkers = (foodData || []).filter(marker => {
          const point = [marker.Long, marker.Lat];
          return geoData.features.some(feature => d3.geoContains(feature, point));
        });

        allMarkers = validMarkers;
        document.getElementById("total-count").textContent = allMarkers.length;

        // Calculate Stats based on USDA Rules
        geoData.features.forEach(feature => {
          const name = feature.properties.SNA_NAME;
          const key = name;

          // 1. Calculate Geographic Access (Distance to nearest Grocery Store)
          // We use the neighborhood Centroid as the proxy point for the neighborhood population center
          const centroid = d3.geoCentroid(feature); // [long, lat]
          let minDistanceMiles = Infinity;

          allMarkers.forEach(m => {
            if (m.Type === 'Grocery Store') { // Only Supermarkets/Grocery
              const storePoint = [m.Long, m.Lat];
              // d3.geoDistance returns radians
              const distRadians = d3.geoDistance(centroid, storePoint);
              const distMiles = distRadians * EARTH_RADIUS_MILES;
              if (distMiles < minDistanceMiles) minDistanceMiles = distMiles;
            }
          });

          // If no grocery stores found at all in list (unlikely), dist is Infinity
          const isLowAccess = minDistanceMiles > ACCESS_DISTANCE_MILES;

          // 2. Economic Qualification (Low Income)
          // Use estimated lookup or fallback to hash-based estimate
          let povertyRate = povertyEstimates[name];
          if (povertyRate === undefined) {
            // Try partial match
            const keys = Object.keys(povertyEstimates);
            const match = keys.find(k => name.includes(k) || k.includes(name));
            if (match) {
              povertyRate = povertyEstimates[match];
            } else {
              // Fallback logic: Deterministic "random" between 0.10 and 0.35
              const nameHash = name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
              povertyRate = 0.10 + (nameHash % 25) / 100;
            }
          }
          const isLowIncome = povertyRate >= POVERTY_THRESHOLD;

          // 3. Desert Status
          const isDesert = isLowAccess && isLowIncome;

          // Basic Counts
          const groceryCount = allMarkers.filter(m => {
            if (m.Type !== 'Grocery Store') return false;
            return d3.geoContains(feature, [m.Long, m.Lat]);
          }).length;

          const totalCount = allMarkers.filter(m => {
            return d3.geoContains(feature, [m.Long, m.Lat]);
          }).length;

          neighborhoodStats[name] = {
            groceryCount,
            totalCount,
            acres: feature.properties.ACRES || 0,
            minDistanceMiles: minDistanceMiles === Infinity ? 0 : minDistanceMiles,
            povertyRate: povertyRate,
            isLowAccess,
            isLowIncome,
            isDesert
          };
        });

        // Count food deserts
        const desertCount = Object.values(neighborhoodStats).filter(s => s.isDesert).length;
        document.getElementById("desert-count").textContent = desertCount;

        // Setup Definitions for Heat Map and Clipping
        const defs = svg.append("defs");
        const clipPath = defs.append("clipPath").attr("id", "mapClip");
        clipPath.selectAll("path")
          .data(geoData.features)
          .enter()
          .append("path")
          .attr("d", path);

        // Simple Green Gradient (Green -> Transparent)
        const greenRadial = defs.append("radialGradient")
          .attr("id", "greenRadial")
          .attr("cx", "50%").attr("cy", "50%").attr("r", "50%");
        greenRadial.append("stop").attr("offset", "0%").attr("stop-color", "#22c55e").attr("stop-opacity", 1);
        greenRadial.append("stop").attr("offset", "50%").attr("stop-color", "#22c55e").attr("stop-opacity", 0.6);
        greenRadial.append("stop").attr("offset", "100%").attr("stop-color", "#22c55e").attr("stop-opacity", 0);

        // Draw Neighborhoods (Outlines Only)
        g.selectAll(".neighborhood")
          .data(geoData.features)
          .enter()
          .append("path")
          .attr("class", "neighborhood")
          .attr("d", path)
          .attr("fill", "transparent")
          .attr("stroke", d => {
            const stats = neighborhoodStats[d.properties.SNA_NAME];
            if (stats && stats.isDesert) {
              return "#fbbf24"; // Yellow border for USDA food deserts
            }
            return "rgba(255, 255, 255, 0.4)";
          })
          .attr("stroke-width", d => {
            const stats = neighborhoodStats[d.properties.SNA_NAME];
            return (stats && stats.isDesert) ? "2.5px" : "1px";
          })
          .attr("stroke-dasharray", d => {
            const stats = neighborhoodStats[d.properties.SNA_NAME];
            return (stats && stats.isDesert) ? "6,4" : "none";
          })
          .attr("pointer-events", "all")
          .on("mouseover", (event, d) => {
            const name = d.properties.SNA_NAME;
            const stats = neighborhoodStats[name];

            if (!stats) return;

            const povDisplay = (stats.povertyRate * 100).toFixed(1) + "%";
            const distDisplay = stats.minDistanceMiles.toFixed(2) + " mi";

            let statusHTML = "";
            if (stats.isDesert) {
              statusHTML = `<span style="color: #fbbf24;">⚠ USDA Food Desert</span>`;
            } else if (stats.isLowAccess) {
              statusHTML = `<span style="color: #f97316;">Low Access Area (>${ACCESS_DISTANCE_MILES}mi)</span>`;
            } else {
              statusHTML = `<span style="color: #22c55e;">✓ Good Access</span>`;
            }

            tooltip.style("opacity", 1)
              .html(`
                 <div style="font-weight: 600; font-size: 1.1rem; margin-bottom: 6px;">${name}</div>
                 <div style="font-weight: 600; margin-bottom: 8px;">
                     ${statusHTML}
                 </div>
                 <div style="font-size: 0.8rem; color: #94a3b8;">
                     <strong>Poverty Rate:</strong> ${povDisplay}<br>
                     <strong>Dist. to Grocery:</strong> ${distDisplay}<br>
                     <strong>Grocery Stores:</strong> ${stats.groceryCount}<br>
                     <strong>Total Food Locs:</strong> ${stats.totalCount}
                 </div>
               `);
          })
          .on("mouseout", () => {
            tooltip.style("opacity", 0);
          });

        // Initial Map Render
        updateMap(allMarkers);

        // Setup Filters
        document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const type = btn.dataset.type;
            if (type === 'all') {
              updateMap(allMarkers);
            } else {
              updateMap(allMarkers.filter(m => m.Type === type));
            }
          });
        });

      } catch (error) {
        console.error("Error loading map data:", error);
      }
    }

    // Spread bias: Grocery stores get larger green circles than restaurants
    const spreadBias = {
      "Grocery Store": 180,
      "Farmers Market/Health": 140,
      "Supermarket": 180,
      "Specialty Food": 100,
      "Convenience/Market": 70,
      "Pharmacy": 70,
      "Dollar Store": 60,
      "Gas Station": 50,
      "Restaurant": 40,
      "Fast Food": 40,
      "Coffee Shop": 40,
      "Dessert": 40
    };
    const defaultSpread = 40;

    function renderHeatmap(markers) {
      // Select or create heat-layer group
      let heatGroup = g.select(".heat-layer");
      if (heatGroup.empty()) {
        heatGroup = g.insert("g", ".neighborhood").attr("class", "heat-layer").attr("clip-path", "url(#mapClip)");
      }

      // Clear previous heat map
      heatGroup.selectAll("*").remove();

      // Base Layer (Dark Red)
      heatGroup.append("rect")
        .attr("width", width)
        .attr("height", height)
        .attr("fill", "#7f1d1d")
        .attr("opacity", 1);

      // Draw access circles
      markers.forEach(d => {
        const p = projection([d.Long, d.Lat]);
        if (!p) return;

        const radius = spreadBias[d.Type] || defaultSpread;

        heatGroup.append("circle")
          .attr("cx", p[0])
          .attr("cy", p[1])
          .attr("r", radius)
          .attr("fill", "url(#greenRadial)")
          .attr("opacity", 0.5)
          .attr("pointer-events", "none");
      });
    }

    function renderMarkers(markers) {
      // Update Markers
      g.selectAll(".store-marker").remove();

      g.selectAll(".store-marker")
        .data(markers)
        .enter()
        .append("circle")
        .attr("class", "store-marker")
        .attr("cx", d => {
          const p = projection([d.Long, d.Lat]);
          return p ? p[0] : 0;
        })
        .attr("cy", d => {
          const p = projection([d.Long, d.Lat]);
          return p ? p[1] : 0;
        })
        .attr("r", 5)
        .attr("fill", d => typeColors[d.Type] || "#fff")
        .attr("stroke", "#000")
        .attr("stroke-width", "1px")
        .attr("opacity", 1)
        .on("mouseover", (event, d) => {
          const statusColor = d.Status.includes("No Violations") ? "#10b981" :
            d.Status.includes("Not In Compliance") ? "#ef4444" : "#f59e0b";
          tooltip.style("opacity", 1)
            .html(`
              <div style="font-weight: 600; color: ${typeColors[d.Type]}; font-size: 1rem;">${d.Name}</div>
              <div style="color: #cbd5e1; font-size: 0.85rem; margin: 4px 0;">${d.Address}</div>
              <div style="font-size: 0.8rem; color: #94a3b8;">
                Type: <span style="color: #fff;">${d.Type}</span><br>
                Status: <span style="color: ${statusColor};">${d.Status}</span><br>
                Neighborhood: <span style="color: #fff;">${d.Neighborhood || 'N/A'}</span>
              </div>
            `);
        })
        .on("mouseout", () => {
          tooltip.style("opacity", 0);
        });

      document.getElementById("total-count").textContent = markers.length;
    }

    function updateMap(markers) {
      renderHeatmap(markers);
      renderMarkers(markers);
    }

    init();
  </script>
</body>

</html>